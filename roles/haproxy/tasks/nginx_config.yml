---
- name: Print iteration number
  debug:
    msg: "Modifiying configuration for nginx-{{ item }}"

- name: "Get infos on container nginx-{{ item }}"
  community.docker.docker_container_info:
    name: "nginx-{{ item }}"
  register: container_results

- name: Replace server number on index
  replace:
    path: "/tmp/haproxy/haproxy.cfg"
    regexp: '# nginx-backend'
    replace: 'server nginx-{{ item }} {{ container_results.container.NetworkSettings.IPAddress }}:108{{ item }} check\n  # nginx-backend'
  when: container_results.exists