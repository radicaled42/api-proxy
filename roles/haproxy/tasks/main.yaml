---
- name: Deploy HAProxy Server
  debug:
    msg: "Deploying HAProxy Server"

- name: Pull haproxy Docker image
  docker_image:
    name: haproxy:3.0.3
    source: pull

- name: Copying haproxy Configuration
  copy:
    src: files/haproxy.cfg
    dest: /tmp/haproxy/

- name: Add nginx servers to haproxy.cfg
  block:
    - name: Print iteration number
      debug:
        msg: "Modifiying configuration for nginx-{{ item }}"

    - name: Run docker inspect command
      shell: "docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' nginx-{{ item }}"
      register: container_ip

    - name: Replace server number on index
      replace:
        path: "/tmp/haproxy/haproxy.cfg"
        regexp: '# nginx-backend'
        replace: 'server nginx-{{ item }} {{ container_ip }}:108{{ item }} check\n  # nginx-backend'

  loop: "{{ range(nginx_number) | list }}"
  when: nginx_number is defined

- name: Run haproxy Docker container
  docker_container:
    name: haproxy
    image: haproxy:3.0.3
    state: started
    ports:
      - "80:80"
      - "8404:8404"
    volumes:
      - "/tmp/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro"
